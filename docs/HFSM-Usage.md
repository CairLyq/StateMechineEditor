# 分层状态机编辑器使用说明

## 概述

分层状态机编辑器（Hierarchical Finite State Machine Editor）是对原有状态机编辑器的增强，支持创建具有父子关系的分层状态结构。

## 核心功能

### 1. 模式切换

- **扁平模式**：传统的状态机编辑模式，所有状态处于同一层级
- **分层模式**：支持父子关系的分层状态机编辑模式

点击工具栏中的 "分层模式/扁平模式" 按钮来切换编辑模式。

### 2. 节点层次结构

#### 根节点（Level 0）
- 最顶层的状态节点
- 具有最粗的边框和最大的阴影
- 可以包含子状态

#### 子节点（Level 1+）
- 隶属于父状态的子状态
- 根据层级深度调整视觉样式
- 支持无限层级嵌套

### 3. 状态类型

#### 简单状态（Leaf State）
- 没有子状态的状态节点
- 实线边框
- 用于表示具体的状态逻辑

#### 复合状态（Composite State）
- 包含一个或多个子状态的状态节点
- 虚线边框
- 带有展开/折叠按钮
- 显示子状态数量

## 操作指南

### 基本操作

1. **切换到分层模式**
   - 点击工具栏中的 "分层模式" 按钮
   - 界面将切换到分层状态机编辑模式

2. **创建根状态**
   - 在画布空白区域双击
   - 或点击 "添加状态" 按钮

3. **创建子状态**
   - 选中一个状态节点
   - 点击 "添加子状态" 按钮
   - 或在选中状态的基础上双击画布

4. **展开/折叠状态**
   - 点击复合状态右上角的 `+`/`-` 按钮
   - 展开显示子状态，折叠隐藏子状态

### 状态管理

1. **编辑状态属性**
   - 右键点击状态节点
   - 选择 "编辑状态"
   - 修改名称、颜色等属性

2. **设置状态类型**
   - 右键菜单中选择 "设为初始状态" 或 "设为终止状态"
   - 初始状态显示 `▶` 符号
   - 终止状态显示 `⏹` 符号

3. **删除状态**
   - 选中状态后按 Delete 键
   - 或右键菜单选择 "删除状态"
   - 删除父状态会同时删除所有子状态

### 转换管理

1. **创建转换**
   - 在分层模式下，转换支持跨层级连接
   - 支持从父状态到子状态的转换
   - 支持子状态之间的转换

2. **转换类型**
   - **内部转换**：同一父状态内的子状态间转换（绿色）
   - **外部转换**：跨父状态的转换（蓝色）
   - **自转换**：状态到自身的转换（橙色）

## 界面元素说明

### 工具栏按钮

- **添加状态**：创建新的根状态或在选中状态处创建子状态
- **添加转换**：创建状态间的转换连接
- **添加子状态**：为选中的状态添加子状态
- **分层模式/扁平模式**：切换编辑模式

### 状态节点视觉元素

1. **层级指示器**：左上角的小圆圈显示状态层级
2. **展开按钮**：右上角的 `+`/`-` 按钮用于展开/折叠子状态
3. **状态类型图标**：
   - `▶`：初始状态
   - `⏹`：终止状态
   - `📁(n)`：复合状态（n为子状态数量）

### 颜色编码

- **绿色**：根级状态默认颜色
- **蓝色**：一级子状态默认颜色
- **橙色**：二级子状态默认颜色
- **紫色**：三级子状态默认颜色

## 导入导出

### 导出功能

- 分层模式下导出的JSON文件包含完整的层次结构信息
- 文件名包含 "hierarchical" 标识
- 元数据中标记为 `hierarchical-state-machine` 类型

### 导入功能

- 自动识别分层或扁平状态机数据
- 导入分层数据时自动切换到分层模式
- 导入扁平数据时自动切换到扁平模式

## 最佳实践

### 1. 状态层次设计

- 保持层次结构清晰，避免过深的嵌套（建议不超过4-5层）
- 将相关的状态组织在同一个父状态下
- 使用有意义的状态名称

### 2. 转换设计

- 优先使用内部转换，减少跨层级的复杂转换
- 为转换添加清晰的触发事件和条件
- 避免创建过于复杂的转换网络

### 3. 视觉组织

- 合理安排状态节点的位置，避免重叠
- 使用展开/折叠功能管理复杂的层次结构
- 保持画布整洁，必要时使用重置功能

## 键盘快捷键

- **Delete**：删除选中的状态或转换
- **Ctrl+D**：显示/隐藏调试面板
- **双击画布**：创建新状态（根据当前选择和模式）

## 调试功能

在分层模式下，调试面板会显示：
- 层次结构信息
- 转换类型分析
- 状态路径信息
- 模式切换日志

## 技术架构

分层状态机编辑器采用模块化设计：

- `HierarchicalStateNode.js`：状态节点类
- `HierarchicalTransition.js`：转换和转换管理器类
- `HierarchicalRenderer.js`：渲染器类
- `HierarchicalStateMachineEditor.js`：主编辑器类

这种设计确保了代码的可读性和可维护性。 